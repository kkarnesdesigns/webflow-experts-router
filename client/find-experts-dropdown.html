<!--
  Find Experts Mega Dropdown - Interactive Filter Menu

  Step 1: Select a Category
  Step 2: Select a Skill or Certification (filtered by category)
  Step 3: Select a Location (states/cities with experts in that skill/certification)
  → Navigates to the final page
-->

<div class="mega-dropdown-inner" id="experts-dropdown">
  <div class="mega-dropdown-loading">Loading...</div>
</div>

<script>
(function() {
  const DROPDOWN_API = 'https://webflow-experts-router.vercel.app/api/dropdown-menu';
  const MANIFEST_API = 'https://webflow-experts-router.vercel.app/api/route-manifest';
  const container = document.getElementById('experts-dropdown');

  let menuData = null;
  let manifestData = null;
  let selectedCategory = null;
  let selectedSkill = null;
  let selectedCertification = null;

  async function loadDropdownData() {
    try {
      const [menuResponse, manifestResponse] = await Promise.all([
        fetch(DROPDOWN_API),
        fetch(MANIFEST_API)
      ]);

      if (!menuResponse.ok || !manifestResponse.ok) throw new Error('Failed to load menu');

      menuData = await menuResponse.json();
      manifestData = await manifestResponse.json();

      renderStep1();
    } catch (error) {
      console.error('Error loading dropdown:', error);
      container.innerHTML = '<div class="mega-dropdown-error">Unable to load menu</div>';
    }
  }

  // Step 1: Select Category
  function renderStep1() {
    selectedCategory = null;
    selectedSkill = null;
    selectedCertification = null;

    container.innerHTML = `
      <div class="mega-dropdown-step">
        <div class="mega-dropdown-step-header">
          <div class="mega-dropdown-step-number">1</div>
          <div class="mega-dropdown-step-title">Select a Category</div>
        </div>
        <div class="mega-dropdown-grid">
          ${menuData.categories.map(c => `
            <button class="mega-dropdown-option" data-category="${c.slug}" data-name="${c.name}">
              <span class="mega-dropdown-option-name">${c.name}</span>
            </button>
          `).join('')}
        </div>
      </div>
    `;

    // Add click handlers
    container.querySelectorAll('[data-category]').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedCategory = {
          slug: btn.dataset.category,
          name: btn.dataset.name
        };
        renderStep2();
      });
    });
  }

  // Step 2: Select Skill/Certification OR Location (skill/cert is optional)
  function renderStep2() {
    // Find skills and certifications for this category from manifest
    const skillsInCategory = [];
    const skillSlugs = new Set();
    const certificationsInCategory = [];
    const certSlugs = new Set();

    // Find locations (states/cities) for this category (without skill/cert filter)
    const statesMap = new Map();
    const citiesMap = new Map();

    for (const [path, params] of Object.entries(manifestData.routes)) {
      if (params.category === selectedCategory.slug) {
        // Collect skills
        if (params.skillId && !skillSlugs.has(params.skill)) {
          skillSlugs.add(params.skill);
          skillsInCategory.push({
            slug: params.skill,
            name: params.skillName,
            expertCount: params.expertCount || 0
          });
        }

        // Collect certifications
        if (params.certificationId && !certSlugs.has(params.certification)) {
          certSlugs.add(params.certification);
          certificationsInCategory.push({
            slug: params.certification,
            name: params.certificationName,
            expertCount: params.expertCount || 0
          });
        }

        // Collect state-level routes for this category (no skill/cert filter)
        if (params.stateId && !params.skillId && !params.certificationId && !params.cityId) {
          if (!statesMap.has(params.stateId)) {
            statesMap.set(params.stateId, {
              path: path,
              name: params.stateName,
              slug: params.state,
              expertCount: params.expertCount || 0
            });
          }
        }

        // Collect city-level routes for this category (no skill/cert filter)
        if (params.cityId && !params.skillId && !params.certificationId) {
          if (!citiesMap.has(params.cityId)) {
            citiesMap.set(params.cityId, {
              path: path,
              name: params.cityName,
              state: params.stateName,
              slug: params.city,
              expertCount: params.expertCount || 0
            });
          }
        }
      }
    }

    // Sort by expert count
    skillsInCategory.sort((a, b) => b.expertCount - a.expertCount);
    certificationsInCategory.sort((a, b) => b.expertCount - a.expertCount);

    const states = Array.from(statesMap.values()).sort((a, b) => b.expertCount - a.expertCount);
    const cities = Array.from(citiesMap.values()).sort((a, b) => b.expertCount - a.expertCount).slice(0, 8);

    // Category index page path
    const categoryIndexPath = `/hire/${selectedCategory.slug}`;

    container.innerHTML = `
      <div class="mega-dropdown-step">
        <div class="mega-dropdown-step-header">
          <button class="mega-dropdown-back" id="back-to-step1">← Back</button>
          <div class="mega-dropdown-step-number">2</div>
          <div class="mega-dropdown-step-title">Narrow Your Search</div>
          <div class="mega-dropdown-step-context">${selectedCategory.name}</div>
        </div>
        <div class="mega-dropdown-index-link">
          <a href="${categoryIndexPath}" class="mega-dropdown-view-all">
            View All ${selectedCategory.name} Experts →
          </a>
        </div>
        <div class="mega-dropdown-four-panel">
          ${skillsInCategory.length > 0 ? `
          <div class="mega-dropdown-panel mega-dropdown-panel--skills">
            <div class="mega-dropdown-subtitle">Skills</div>
            <div class="mega-dropdown-list mega-dropdown-list--scroll">
              ${skillsInCategory.map(s => `
                <button class="mega-dropdown-option mega-dropdown-option--compact" data-skill="${s.slug}" data-name="${s.name}">
                  <span class="mega-dropdown-option-name">${s.name}</span>
                </button>
              `).join('')}
            </div>
          </div>
          ` : ''}
          ${certificationsInCategory.length > 0 ? `
          <div class="mega-dropdown-panel mega-dropdown-panel--certs">
            <div class="mega-dropdown-subtitle">Certifications</div>
            <div class="mega-dropdown-list mega-dropdown-list--scroll">
              ${certificationsInCategory.map(c => `
                <button class="mega-dropdown-option mega-dropdown-option--compact" data-certification="${c.slug}" data-name="${c.name}">
                  <span class="mega-dropdown-option-name">${c.name}</span>
                </button>
              `).join('')}
            </div>
          </div>
          ` : ''}
          <div class="mega-dropdown-panel mega-dropdown-panel--states">
            <div class="mega-dropdown-subtitle">States</div>
            <div class="mega-dropdown-list mega-dropdown-list--scroll">
              ${states.map(s => `
                <a href="${s.path}" class="mega-dropdown-link">
                  <span>${s.name}</span>
                </a>
              `).join('')}
            </div>
          </div>
          ${cities.length > 0 ? `
          <div class="mega-dropdown-panel mega-dropdown-panel--cities">
            <div class="mega-dropdown-subtitle">Top Cities</div>
            <div class="mega-dropdown-list mega-dropdown-list--scroll">
              ${cities.map(c => `
                <a href="${c.path}" class="mega-dropdown-link">
                  <span>${c.name}, ${c.state}</span>
                </a>
              `).join('')}
            </div>
          </div>
          ` : ''}
        </div>
      </div>
    `;

    // Back button
    document.getElementById('back-to-step1').addEventListener('click', renderStep1);

    // Skill click handlers - goes to Step 3 with skill+location
    container.querySelectorAll('[data-skill]').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedSkill = {
          slug: btn.dataset.skill,
          name: btn.dataset.name
        };
        selectedCertification = null;
        renderStep3();
      });
    });

    // Certification click handlers - goes to Step 3 with certification+location
    container.querySelectorAll('[data-certification]').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedCertification = {
          slug: btn.dataset.certification,
          name: btn.dataset.name
        };
        selectedSkill = null;
        renderStep3();
      });
    });
  }

  // Step 3: Select Location (states/cities with this category+skill/certification combo)
  function renderStep3() {
    // Find locations for this category+skill or category+certification from manifest
    const statesMap = new Map();
    const citiesMap = new Map();

    // Determine what we're filtering by
    const filterName = selectedSkill ? selectedSkill.name : selectedCertification.name;
    const filterSlug = selectedSkill ? selectedSkill.slug : selectedCertification.slug;
    const filterType = selectedSkill ? 'skill' : 'certification';

    for (const [path, params] of Object.entries(manifestData.routes)) {
      // Match based on whether we're filtering by skill or certification
      const matchesFilter = selectedSkill
        ? (params.category === selectedCategory.slug && params.skill === selectedSkill.slug)
        : (params.category === selectedCategory.slug && params.certification === selectedCertification.slug);

      if (matchesFilter) {
        // State-level route
        if (params.stateId && !params.cityId) {
          if (!statesMap.has(params.stateId)) {
            statesMap.set(params.stateId, {
              path: path,
              name: params.stateName,
              slug: params.state,
              expertCount: params.expertCount || 0
            });
          }
        }
        // City-level route
        if (params.cityId) {
          if (!citiesMap.has(params.cityId)) {
            citiesMap.set(params.cityId, {
              path: path,
              name: params.cityName,
              state: params.stateName,
              slug: params.city,
              expertCount: params.expertCount || 0
            });
          }
        }
      }
    }

    const states = Array.from(statesMap.values()).sort((a, b) => b.expertCount - a.expertCount);
    const cities = Array.from(citiesMap.values()).sort((a, b) => b.expertCount - a.expertCount).slice(0, 12);

    // Index page path for skill or certification (no location)
    const indexPath = `/hire/${selectedCategory.slug}/${filterSlug}`;

    container.innerHTML = `
      <div class="mega-dropdown-step">
        <div class="mega-dropdown-step-header">
          <button class="mega-dropdown-back" id="back-to-step2">← Back</button>
          <div class="mega-dropdown-step-number">3</div>
          <div class="mega-dropdown-step-title">Select a Location</div>
          <div class="mega-dropdown-step-context">${filterName} in ${selectedCategory.name}</div>
        </div>
        <div class="mega-dropdown-index-link">
          <a href="${indexPath}" class="mega-dropdown-view-all">
            View All ${filterName} Experts →
          </a>
        </div>
        <div class="mega-dropdown-locations">
          <div class="mega-dropdown-locations-col">
            <div class="mega-dropdown-subtitle">By State</div>
            <div class="mega-dropdown-list mega-dropdown-list--scroll">
              ${states.map(s => `
                <a href="${s.path}" class="mega-dropdown-link">
                  <span>${s.name}</span>
                </a>
              `).join('')}
            </div>
          </div>
          ${cities.length > 0 ? `
          <div class="mega-dropdown-locations-col">
            <div class="mega-dropdown-subtitle">Top Cities</div>
            <div class="mega-dropdown-list mega-dropdown-list--scroll">
              ${cities.map(c => `
                <a href="${c.path}" class="mega-dropdown-link">
                  <span>${c.name}, ${c.state}</span>
                </a>
              `).join('')}
            </div>
          </div>
          ` : ''}
        </div>
      </div>
    `;

    // Back button
    document.getElementById('back-to-step2').addEventListener('click', renderStep2);
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadDropdownData);
  } else {
    loadDropdownData();
  }
})();
</script>
